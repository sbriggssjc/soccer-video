# `ball_path_planner_v3.py` CLI reference

## Command line arguments

| Flag | Default | Description |
| --- | --- | --- |
| `--in` | _required_ | Input video path. `argparse` marks this as required. |
| `--init-manual` | `False` | If set, opens a GUI selector to manually choose the initial ball position. |
| `--init-t` | `0.8` | Timestamp (seconds) within the clip to seed the manual initialization frame. |
| `--anchors` | _required_ | Path to the JSONL file generated by `ball_anchors.py` that supplies per-frame anchor positions. |
| `--out` | _required_ | Destination JSONL file for the tracked ball path and zoom records. |
| `--max-cands` | `16` | Maximum number of candidate detections that survive scoring per frame. |
| `--search-r` | `320` | Radius in pixels for the search window around the predicted ball position (expanded adaptively on misses). |
| `--min-r` | `6` | Minimum allowed ball radius in pixels. |
| `--max-r` | `22` | Maximum allowed ball radius in pixels. |

## Flag behaviour highlights

- **Search window / radius** – `--search-r` seeds the per-frame search radius. The planner adds up to `min(240, 40 * misses)` extra pixels when consecutive frames are missed, and can fall back to a full-frame sweep if the miss streak exceeds 10 frames. 【F:tools/ball_path_planner_v3.py†L460-L501】
- **Candidate budget** – `--max-cands` limits how many scored candidates are kept from contour/Hough detections per frame. A secondary full-frame fallback doubles this cap when invoked. 【F:tools/ball_path_planner_v3.py†L227-L241】【F:tools/ball_path_planner_v3.py†L476-L500】
- **Ball radius / scale** – `--min-r` and `--max-r` gate acceptable contour areas and Hough circle radii. After manual initialization the script tightens these bounds based on the sampled ROI. 【F:tools/ball_path_planner_v3.py†L208-L224】【F:tools/ball_path_planner_v3.py†L429-L457】
- **Appearance filtering** – `field_mask_bgr` performs an adaptive green-cluster segmentation in BGR/HSV space to constrain candidates to the pitch. `motion_strength` scores frame differencing, and `ncc_score` + radial gradients favour bright circular blobs. 【F:tools/ball_path_planner_v3.py†L39-L197】
- **Gap handling / interpolation** – The DP solver allows a `miss` pseudo-candidate with penalty `miss_pen=1.35` and clamps frame-to-frame jumps to `max_jump=280`. Missing spans are filled with the last known coordinate, then smoothed with forward/backward exponential moving averages. 【F:tools/ball_path_planner_v3.py†L242-L328】
- **Stabilised vs raw output** – Each record keeps stabilised (`bx`, `by`, `bx_stab`, `by_stab`) and raw coordinates (`bx_raw`, `by_raw`) along with zoom `z`. Stabilised values stay in the warped (field-aligned) frame, while raw values map back to original pixel space via the inverse affine transform. 【F:tools/ball_path_planner_v3.py†L517-L557】

## Output schema

Every output line is a JSON object containing:

- `t`: Time in seconds from clip start.
- `bx` / `by`: Stabilised ball centre in pixels (0–width/height-1) within the stabilised frame.
- `bx_stab` / `by_stab`: Duplicates of the stabilised coordinates for downstream compatibility.
- `bx_raw` / `by_raw`: Ball centre in original source pixel space (pre-stabilisation).
- `z`: Planned zoom factor (unitless scale relative to portrait framing heuristic).

All coordinates are clamped to the 0..width-1 / 0..height-1 range of the source clip before writing. 【F:tools/ball_path_planner_v3.py†L517-L557】

## Suggested tuning: fast U13 (1080p @ 24 fps)

For quick youth-play footage with jittery pans and smaller ball appearance, start with conservative search and robust gap handling:

```bash
python tools/ball_path_planner_v3.py \
  --in fast_u13_game.mp4 \
  --anchors anchors.jsonl \
  --out ball_path.jsonl \
  --init-manual \
  --init-t 0.6 \
  --search-r 260 \
  --max-cands 20 \
  --min-r 5 \
  --max-r 26
```

**Rationale:**

- Slightly smaller `--search-r` (260) keeps the candidate search tight for faster lateral motion while still expanding during miss streaks.
- Raising `--max-cands` to 20 captures more ambiguous detections caused by motion blur.
- Broader radius range (`5–26`) accommodates the small ball size at 1080p yet allows occasional closer zooms.
- Manual init around 0.6 s positions the ROI nearer kickoff and helps stabilisation lock on early.
```
